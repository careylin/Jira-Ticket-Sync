(()=>{"use strict";var e=function(e,t,i,a){return new(i||(i=Promise))((function(n,o){function r(e){try{l(a.next(e))}catch(e){o(e)}}function s(e){try{l(a.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,s)}l((a=a.apply(e,t||[])).next())}))};const t=figma.currentPage.parent;t.setRelaunchData({update_page:"",update_all:""});const i="COMPANY_NAME",a="PROJECT_ID",n="USERNAME",o="PASSWORD",r="ISSUE_ID",s="CREATE_LINK";var l,d,c,f,m,u;const g={family:"Work Sans",style:"Regular"},y={family:"Work Sans",style:"Medium"},p={family:"Work Sans",style:"Bold"};function h(e){return e.fields.statuscategorychangedate}function v(e){return e.fields.assignee.displayName}function T(e){return e.fields.description}var S=0;const A="Ticket ID",E="Ticket Title",I="Date of Status Change",D="Assignee",C="Description",w="Jira Ticket Header",x=W("EEEEEE"),k=W("FFEDC0"),R=W("D7E0FF"),N=W("D7E0FF"),M=W("C0E9BF "),_=W("B9B9B9"),F=W("FFD9D9");var z;function O(t){return e(this,void 0,void 0,(function*(){figma.showUI(__html__,{visible:!1}),yield P(),!U(t)||"all"!==t&&"page"!==t&&"selection"!==t||figma.closePlugin()}))}function P(){return e(this,void 0,void 0,(function*(){l=yield $(i,!0),d=yield $(a,!0),c=yield $(n,!1),f=yield $(o,!1),m=yield $(r,!1),""===(u=yield $(s,!1))&&(u=!0),figma.ui.postMessage({company_name:l,project_id:d,username:c,password:f,issueId:m,createLink:u,type:"setAuthorizationVariables"})}))}function $(i,a=!1){return e(this,void 0,void 0,(function*(){var e;return(e=a?t.getPluginData(i):yield figma.clientStorage.getAsync(i))||0==e||(e=""),e}))}function U(e){let i,a=!1;return"all"==e?(i=t.findAllWithCriteria({types:["INSTANCE"]}),i=i.filter((e=>e.name===w)),0==i.length?(figma.notify("No instances named 'Jira Ticket Header' found in document."),a=!0):b(i)):"page"==e?(i=figma.currentPage.findAllWithCriteria({types:["INSTANCE"]}),i=i.filter((e=>e.name===w)),0==i.length?(figma.notify("No instances named 'Jira Ticket Header' found on page."),a=!0):b(i)):"selection"==e&&(i=figma.currentPage.selection,0==i.length?(figma.notify("Nothing selected."),a=!0):b(i)),a}function b(t){return e(this,void 0,void 0,(function*(){var e=[],i=[];for(let a=0;a<t.length;a++){const n=t[a];if("INSTANCE"!==n.type)figma.notify("The element needs to be an instance of Jira Ticket Header");else{let t=n.findOne((e=>"TEXT"===e.type&&e.name===A));t?(i.push(t.characters),e.push(n.id)):figma.notify("At least one instance is missing the text element 'Ticket ID'. Could not update.")}}figma.ui.postMessage({nodeIds:e,issueIds:i,type:"getTicketData"})}))}function L(t,i,a=!1){return e(this,void 0,void 0,(function*(){var e,n=i.data,o=i.issueIds,r=t.length,s=[],d=0,c=0,f=0,m=[];for(let e=0;e<r;e++){let i=t[e],a=J(n[e],o[e]),r=a.fields.status.name;"Error"===r&&s.push(o[e]);let y=z.findChild((e=>e.name==="Status="+r));y||(y=z.defaultVariant,m.push(r));let p=i.findOne((e=>"TEXT"===e.type&&e.name===E));p?(yield figma.loadFontAsync(p.fontName),p.characters=a.fields.summary,p.hyperlink={type:"URL",value:`https://${l}.atlassian.net/browse/${a.key}`}):d+=1;let S=i.findOne((e=>"TEXT"===e.type&&e.name===I));if(S){yield figma.loadFontAsync(S.fontName);var u=new Date(h(a).replace(/[T]+.*/,""));S.characters=u.toDateString()}else c+=1;let A=i.findOne((e=>"TEXT"===e.type&&e.name===D));if(A)if(yield figma.loadFontAsync(A.fontName),a.fields.assignee){let e=v(a);A.characters=e}else A.characters="Not assigned";else f+=1;let w=i.findOne((e=>"TEXT"===e.type&&e.name===C)),x=T(a);if(w&&x){let e="Helvetica",t={family:e,style:"Regular"};for(yield figma.loadFontAsync(t),w.fontName=t;x.match(/\n(\*)+[^\w]/);){let e=x.match(/\n(\*)+[^\w]/)[0].length;e=2*(e-2);var g=new Array(e).join(" ");x=x.replace(/\n(\*)+[^\w]/,`\n${g}â€¢ `)}w.characters=x;let i=/\{panel.*?}(.+?)\{panel\}/s,a={family:e,style:"Regular"};yield H(w,i,a,1,"-------","-------");let n=/\{noformat\}(.*?)\{noformat\}/s,o={family:"Courier",style:"Regular"};yield H(w,n,o,1,"-------\n","-------");let r=/\*(.+?)\*/,s={family:e,style:"Bold"};yield H(w,r,s,1);let l=/_([^_].*?)_/,d={family:e,style:"Oblique"};yield H(w,l,d,1);let c=/h([1-9])\.\s(.*)/,f={family:e,style:"Bold"};yield H(w,c,f,2)}i.swapComponent(y),i.setRelaunchData({update_selection:""})}if(m.length>0){let e=(m=[...new Set(m)]).join("', '");figma.notify(`Status '${e}' not existing. You can add it as a new variant to the main component.`,{timeout:6e3})}d>0&&figma.notify(`${d} tickets are missing text element 'Ticket Title'.`),c>0&&figma.notify(`${c} tickets are missing text element 'Date of Status Change'.`),f>0&&figma.notify(`${f} tickets are missing text element 'Assignee'.`);var y=s.length;return y==r?e=1==r?"Invalid ID.":`${y} of ${r} IDs are invalid or do not exist.`:0==y?(e=1==r?"Updated.":`${r} of ${r} header(s) updated!`,a&&(e="")):e=`${r-y} of ${r} successfully updated. `+(1==y?"1 ID is invalid or does not exist.":`${y} IDs are invalid or do not exist.`),"update_page"===figma.command||"update_all"===figma.command||"update_selection"===figma.command?figma.closePlugin(e):figma.notify(e,{timeout:2e3}),t}))}function H(t,i,a,n,o="",r=""){return e(this,void 0,void 0,(function*(){for(yield figma.loadFontAsync(a);t.characters.match(i);){let e=t.characters.match(i),s=e[0].length,l=e.index,d=e[n],c=o+d+r;s>0&&(t.deleteCharacters(l,l+s),t.insertCharacters(l,c),t.setRangeFontName(l,l+c.length,a))}return t}))}function B(t,i){return e(this,void 0,void 0,(function*(){var a=figma.createComponent();a.name=i,a.layoutMode="VERTICAL",a.resize(600,200),a.counterAxisSizingMode="FIXED",a.primaryAxisSizingMode="AUTO",a.paddingTop=24,a.paddingRight=24,a.paddingBottom=24,a.paddingLeft=24,a.itemSpacing=16,a.cornerRadius=4,a.fills=[{type:"SOLID",color:t}];var n=figma.createFrame();n.name="Container",n.layoutMode="HORIZONTAL",n.counterAxisSizingMode="AUTO",n.layoutAlign="STRETCH",n.itemSpacing=40,n.fills=[];var o=figma.createFrame();o.name="Container",o.layoutMode="HORIZONTAL",o.counterAxisSizingMode="AUTO",o.layoutAlign="STRETCH",o.itemSpacing=32,o.fills=[];var r=figma.createFrame();return r.name="Container",r.layoutMode="HORIZONTAL",r.counterAxisSizingMode="AUTO",r.layoutAlign="STRETCH",r.itemSpacing=32,r.cornerRadius=8,r.verticalPadding=16,r.horizontalPadding=16,r.fills=[{type:"SOLID",color:{r:1,g:1,b:1}}],function(){return e(this,void 0,void 0,(function*(){yield figma.loadFontAsync(g),yield figma.loadFontAsync(y),yield figma.loadFontAsync(p)}))}().then((()=>{const e=figma.createText();e.fontName=g,e.fontSize=32,e.textDecoration="UNDERLINE",e.autoRename=!1,e.characters="Ticket title",e.name=E;const t=figma.createText();t.fontName=y,t.fontSize=32,t.autoRename=!1,t.characters="ID-1",t.name=A;const i=figma.createText();i.fontName=g,i.fontSize=24,i.autoRename=!1,i.characters="MM DD YYYY",i.name=I;const s=figma.createText();s.fontName=g,s.fontSize=24,s.autoRename=!1,s.characters="Name of assignee",s.name=D;const l=figma.createText();l.fontName=g,l.fontSize=24,l.autoRename=!1,l.characters="Description",l.name=C,l.layoutGrow=1,a.appendChild(n),a.appendChild(o),a.appendChild(r),n.appendChild(t),n.appendChild(e),o.appendChild(s),o.appendChild(i),r.appendChild(l),e.layoutGrow=1,s.layoutGrow=1})).catch((()=>{figma.notify("Font '"+g.family+"' could not be loaded. Please install the font.")})),n.primaryAxisSizingMode="FIXED",n.layoutAlign="STRETCH",o.primaryAxisSizingMode="FIXED",o.layoutAlign="STRETCH",r.primaryAxisSizingMode="FIXED",r.layoutAlign="STRETCH",a}))}function X(){return e(this,void 0,void 0,(function*(){let e;const i=[yield B(_,"Status=Default"),yield B(x,"Status=To Do"),yield B(k,"Status=Concepting"),yield B(R,"Status=Design"),yield B(N,"Status=Testing"),yield B(M,"Status=Launch"),yield B(F,"Status=Error")];return e=figma.combineAsVariants(i,figma.currentPage),e.name=w,e.layoutMode="VERTICAL",e.counterAxisSizingMode="AUTO",e.primaryAxisSizingMode="AUTO",e.paddingTop=16,e.paddingRight=16,e.paddingBottom=16,e.paddingLeft=16,e.itemSpacing=24,e.cornerRadius=4,t.setPluginData("ticketComponentID",e.id),e.x=figma.viewport.center.x-e.width/2,e.y=figma.viewport.center.y-e.height/2,e}))}function Y(e){if(!e)throw figma.notify("Something went wrong."),new Error("Something went wrong."+e);if("Error"==e.type)throw figma.notify("Could not get data. There seems to be no connection to the server."),new Error(e.message);if("Client must be authenticated to access this resource."==e[0].message)throw figma.notify("You have entered an invalid e-mail. See 'Authorization' settings."),new Error(e.message);if("Site temporarily unavailable"==e[0].errorMessage)throw figma.notify("Company domain name does not exist. See 'Project Settings'."),new Error(e[0].errorMessage);if(e[0][0])throw figma.notify("Could not access data. Your Jira API Token seems to be invalid. See 'Authorization' settings."),new Error(e[0][0]);return!0}function J(e,t){var i;return e&&e.key?i=e:"The issue no longer exists."==e.errorMessages?i=V(`Error: Ticket ID '${t}' does not exist.`,t):"Issue key is in an invalid format."==e.errorMessages?i=V(`Error: Ticket ID '${t}' is in an invalid format.`,t):(i=V("Error: An unexpected error occured.",t),figma.notify("Unexpected error."),console.error("Unexpected error.",e)),i}function V(e,t){return{key:t,fields:{summary:e,status:{name:"Error"},statuscategorychangedate:(new Date).toISOString()}}}function W(e){var t=parseInt(e,16);return{r:(t>>16&255)/255,g:(t>>8&255)/255,b:(255&t)/255}}"update_selection"===figma.command?O("selection"):"update_all"===figma.command?O("all"):"update_page"===figma.command?O("page"):(figma.showUI(__html__,{width:250,height:308}),P()),function(){e(this,void 0,void 0,(function*(){if(!z){var e=t.getPluginData("ticketComponentID");let i;z=e&&(i=figma.getNodeById(e))?i:yield X()}}))}(),figma.ui.onmessage=g=>e(void 0,void 0,void 0,(function*(){if("create-component"===g.type&&(z=yield X(),t.setPluginData("ticketComponentID",z.id)),"create-new-ticket"===g.type&&Y(g.data)){let t=yield function(t){return e(this,void 0,void 0,(function*(){let e=z.defaultVariant.createInstance();e.x=figma.viewport.center.x-e.width/2+S,e.y=figma.viewport.center.y-e.height/2+S,S=(S+10)%70,figma.currentPage.selection=[e];let i=J(t.data[0],t.issueIds[0]);e=(yield L([e],t,!0))[0];let a=e.findOne((e=>"TEXT"===e.type&&e.name===A));return a?(yield figma.loadFontAsync(a.fontName),a.characters=i.key):figma.notify("Could not find text element named 'Ticket ID'."),e}))}(g);if(g.createLink&&g.data[0].key&&""!=d){let e=encodeURIComponent(figma.root.name),i=encodeURIComponent(t.id),a=`https://www.figma.com/file/${d}/${e}?node-id=${i}`;figma.ui.postMessage({issueId:g.issueIds[0],link:a,type:"post-link-to-jira-issue"})}}if("update-all"===g.type&&U("all"),"update-page"===g.type&&U("page"),"update-selected"===g.type&&U("selection"),"authorization-detail-changed"===g.type&&function(g,y,p=!1){e(this,void 0,void 0,(function*(){p?t.setPluginData(g,y):yield figma.clientStorage.setAsync(g,y),g===i?l=y:g===a?d=y:g===n?c=y:g===o?f=y:g===r?m=y:g===s&&(u=y)}))}(g.key,g.data,g.save_public),"resize-ui"===g.type&&(g.big_size?figma.ui.resize(250,650):figma.ui.resize(250,308)),"create-visual-bell"===g.type&&figma.notify(g.message),"ticketDataSent"===g.type&&Y(g.data)){var y=g.nodeIds.map((e=>figma.getNodeById(e)));yield L(y,g)}}))})();